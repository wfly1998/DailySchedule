## Day 32 2021-02-01

接近年关，忙起来了。今天时间不是很多

而且，事情没有我想象的那么简单

我注意到，AXI Quad SPI 这一 IP Core 只要打开 STARTUP Primitive 的话，Flash 的管脚里就不会有 `sck` 这一信号，这一点 NonTrivialMIPS 和 Fuxi 似乎都是这么做的

那么，读 Flash 到底需不需要 `sck` 这一信号呢

又折腾了好久，大部分时间都用到综合+布线上了，结果还是没能研究出能正常读 CFG Flash 的配置

整了一个 MicroBlaze，加上了 SPI，但是依旧连 Hello World 都输出不了

要不明天再排列组合一下，还不行的话就先放弃？

### Day 32 进展

没有进展

### Day 33 计划

1. 继续折腾 Flash
2. 移植 OpenSBI

### Day 33 2021-02-02

今天也好忙。折腾 Flash 一上午，没有成功，开始折腾 OpenSBI

我注意到把开始点设为 `0x00000200` 后，`objdump` 的结果总是 `0x00001000`，看了下 `.ld` 文件，是给对齐到 4K 了，那么只能改 Fuxi 的起始地址以及 `bin2coe.py` 的 `00000000` 个数了

开始把 OpenSBI 丢到 ROM 里，跟踪发现代码会从 `_relocate_copy_to_lower` 进入 `_start_hang` 这段，观察了一下，似乎还是起始位置的问题，直接把起始地址改成 `0x00001000` 好了

然而修改之后还是会进入 `_start_hang`，这次是从 `_start_warm` 进入的，看代码应该是让 `non-boot HARTs` 进入等待，而 `boot HART` 应该继续往下执行。这里是根据 HART 的 ID 和 HART 的数量把当前核心判断成非启动核心了，可能需要仿真一下看看寄存器的值，有必要的话，还可能需要改 Fuxi CPU

仿真在 `_start_warm` 前面的 `_wait_for_boot_hart` 死循环了

观察了下 ILA 的波形，发现 `fuxi_debug_waddr` 就是这一时钟周期修改的寄存器编号，`fuxi_debug_wdata` 是对其修改的值

分析一下 `_start_warm` 的代码：

```asm
_start_warm:
	/* Reset all registers for non-boot HARTs */
	li	ra, 0
	call	_reset_regs

	/* Disable and clear all interrupts */
	csrw	CSR_MIE, zero
	csrw	CSR_MIP, zero

	/* Find HART count and HART stack size */
	la	a4, platform									/* a4 = 127b0 */
#if __riscv_xlen == 64
	lwu	s7, SBI_PLATFORM_HART_COUNT_OFFSET(a4)
	lwu	s8, SBI_PLATFORM_HART_STACK_SIZE_OFFSET(a4)
#else
	lw	s7, SBI_PLATFORM_HART_COUNT_OFFSET(a4)			/* s7 = de0de1c (SHOULD BE 1) */
	lw	s8, SBI_PLATFORM_HART_STACK_SIZE_OFFSET(a4)		/* s8 = de0de1c */
#endif
	REG_L	s9, SBI_PLATFORM_HART_INDEX2ID_OFFSET(a4)	/* s9 = de0de1c (SHOULD BE 0) */

	/* Find HART id */
	csrr	s6, CSR_MHARTID								/* s6 = 0 */

	/* Find HART index */
	beqz	s9, 3f										/* if s9 == 0 then goto 3 (SHOULD JUMP) */
	li	a4, 0											/* a4 = 0 */
1:
#if __riscv_xlen == 64
	lwu	a5, (s9)
#else
	lw	a5, (s9)										/* a5 = dec0de1c */
#endif
	beq	a5, s6, 2f										/* if a5 == s6 then goto 2 */
	add	s9, s9, 4										/* s9 += 4 (s9 = dec0de20) */
	add	a4, a4, 1										/* a4 += 1 (a4 = 1) */
	blt	a4, s7, 1b										/* if a4 < s7 then goto 1 (WHY IT DOES JUMP ???) */
	li	a4, -1											/* a4 = -1 */
2:	add	s6, a4, zero									/* s6 = a4 ( = -1) */
3:	bge	s6, s7, _start_hang								/* if s6 >= s7 then goto _start_hang */
```

现在主要问题出在 `lw s8, SBI_PLATFORM_HART_STACK_SIZE_OFFSET(a4)` 这一指令上，应该读到的是 `0`，但是却读到了 `de0de1c` 这个奇怪的值

检查了一下，`ocm.coe` 文件没有问题，我怀疑是 ROM 的问题

果然，OpenSBI 的 `.bin` 文件是 77K，加上前面 4K 的偏移共计 81K，而分配给 ROM 的尺寸是 64K，看来需要改一下 ROM 的大小

明天再折腾吧，今天好累

### Day 33 进展

* 学会用 ILA 调试程序了
* 解决了几个导致 OpenSBI 启动不起来的原因

### Day 34 计划

1. 让 OpenSBI 在 Fuxi SoC 上启动起来
2. 启动 OpenSBI 之后继续折腾 Flash

